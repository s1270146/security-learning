# 共通鍵暗号

## 共通鍵暗号の種類

### DES

ブロック暗号

暗号に使用する鍵長は56bit

**Feistel構造**→暗号化と復号で同じ回路を使うことができる

### AES

ブロック暗号

DESの後継

**SPN**(Substitution Permutation Network)という構造を使用

置換と転置によって暗号化

復号のために逆関数を用意する必要がある

### RC4

ストリーム暗号

鍵を内部状態に変換する**KSA**

内部状態から暗号化用のXOR鍵(鍵ストリーム)を出力する**PRGA**

の二種類のアルゴリズムからなる

#### KSA : Key Scheduling Algorithm

最初に暗号鍵を用いてそれに応じた内部状態を生成する

内部状態は0から255の値を鍵に応じて並べ替えたもの全部で256!通りある←総当り不可

#### PRGA : Pseudo-Random Generation Algorithm

KSAで生成した内部情報をもとに、内部状態のかき混ぜと1バイトの乱数出力を繰り返す

PRGAから出力される乱数と平文をXORした結果が暗号文となる

### ChaCha20

ストリーム暗号

RC4の後継

### トリプルDES

鍵を3つ用意して、「暗号化(鍵1)→復号(鍵2)→暗号化(鍵3)」として暗号化する

鍵長は、56 × 3 = 168bitになるが、

中間一致攻撃により、実際の強度は112bit分

## ブロック暗号とストリーム暗号

### ブロック暗号

特定のbit数を一度に暗号化する方法

一定量のデータをまとめて復号する

ストリーム暗号と比べてブロック暗号のほうが安全性の検証が進んでいる

### ストリーム暗号

1bit・1byte単位で暗号化する方式

逐次復号できる

小規模での実装やサイズが変動しやすい場合に適している

## パディング方式

ブロック暗号では、固定長のメッセージを行うためにその長さより短いメッセージを暗号化するためのルールが必要になる

### PKCS#7 パディング

PKCS(Public-key Cryptography Standarts)の7番として定められた、仕様の中で言及されているパディング方式

1ブロックを255バイトまでとしてブロックサイズに満たない部分を足りないバイト数で埋める

ブロックサイズちょうどのデータが与えられた場合、パディングのみで構成されるブロックを一つ追加する

末尾1バイトの値をパディングのバイト数にして、パディングを取り除くときにその値をもとに末尾から削除する

### ゼロパディング

ブロックサイズになるまでnulバイトで埋める方法

元のデータがnulバイトであった場合にどこまでがパディングかわからなくなってしまうのが欠点

ブロックサイズちょうどのデータのときは、追加のブロックを用意する必要はない

## ブロック暗号利用モード

ブロック暗号は固定長であるので、それより大きいサイズのメッセージが来たときに、安全に暗号化するためのテクニック

### ECBモード(Electronic CodeBlock)

単純にメッセージを分割してそのまま暗号化する方法

平文のブロックが一致しているとき、暗号文のブロックも同じものが出力されてしまう

### CBCモード(Cipher Block Chaining)

暗号化する前に平文を一つ前のブロックの暗号文とXORしてから暗号化する方式

最初の1ブロックは、一つ前のブロックが存在しないので **IV(初期化ベクトル)** という値を用意する

### CTRモード(CounTeR)

Nonceというランダムな値とブロックごとにインクリメントするカウンタの2つの値から擬似乱数を出力することで、ブロック暗号をストリーム暗号として使う方式

## ビットフリップ攻撃

ストリーム暗号では、暗号文のあるビットを反転させると平文の同じ場所のビットが反転するという特徴がある

平文の一部が既知である場合やプロトコルが既知で平文の構造が分かっている場合には平文を狙った値に書き換えることができる

CBCモードの復号では、ブロック暗号による復号のあとに1ブロック前の暗号文をXORした結果が平文になる

したがって、1ビット暗号文を反転するとその次のブロックの平文の同じ位置のビットが反転する

副作用としてビットを反転した暗号文のブロックがまるごと壊れてしまう

CBCモードに対するビットフリップ攻撃の応用としてパディングオラクル攻撃という攻撃手法がある

## ECBモードに対する攻撃

平文ブロックと暗号文ブロックが一対一で紐づく

入力値を多くすることで暗号文の中から反復している文字列を見つける

入力値を工夫して暗号文を複数出力させて、それの一部を組み合わせることで意味の通る暗号文を作成することができる

## パディングオラクル攻撃

CBCモードにおいて復号を行うときに、PKCS#7パディングが不正であるというエラーが発生する場合に有効なテクニック

### パディングオラクルの原理

CBCモードを利用した暗号では、あるビットを反転すると次のブロックの平文で同じ場所のビットが反転するというビットフリップ攻撃ができる

復号したいブロックの左側にビットフリップ攻撃用のブロックをつけた2ブロックの暗号文を用意する

ビットフリップ攻撃用のブロックの下位1バイトの値を色々な値に変更して復号結果を確認する

復号時のパディングチェックを通過したとき、平文の下位1バイトの値は``01``になっている

そうすると復号したい暗号文ブロックの一つ前の暗号文ブロックとxorする値の下位1バイトを計算することができる


